<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile POC Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-mobile-alt text-primary text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">Mobile POC Tester</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="currentTime"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">Online</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Upload Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">Upload POC</h2>
                        <p class="text-sm text-gray-600 mt-1">Upload your proof of concept APK file for testing.</p>
                    </div>
                    
                    <div class="p-6">
                        <!-- Challenge Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-flag mr-2"></i>Challenge
                            </label>
                            <select id="challengeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="" disabled selected>Select a challenge</option>
                            {% for challenge in challenges %}
                                <option value="{{ challenge }}">{{ challenge }}</option>
                            {% endfor %}
                            </select>
                        </div>

                        <!-- Proof of Work Section -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-shield-alt mr-2"></i>Proof of Work
                            </label>
                            <div class="mb-3">
                                <div class="flex items-center bg-gray-800 rounded">
                                    <div class="flex-1 text-green-400 p-3 font-mono text-sm overflow-x-auto" id="powCommand">
                                        curl -sSfL https://pwn.red/pow | sh -s {{ session.get('challenge', 'CHALLENGE_TOKEN') }}
                                    </div>
                                    <button onclick="copyToClipboard(`curl -sSfL https://pwn.red/pow | sh -s {{ session.get('challenge', 'CHALLENGE_TOKEN') }}`)" id="powCopyButton"
                                            class="px-3 py-3 text-gray-400 hover:text-white transition-colors"
                                            title="Copy command">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="text" id="powSolution" placeholder="Enter PoW solution here" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <!-- File Upload Section -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-file-upload mr-2"></i>APK File
                            </label>
                            
                            <!-- Drag & Drop Area -->
                            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer">
                                <div id="dropZoneContent">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                    <p class="text-lg text-gray-600 mb-2">Drag & drop your APK file here</p>
                                    <p class="text-sm text-gray-500 mb-4">or click to browse</p>                                    
                                </div>
                            </div>
                            <input type="file" id="fileInput" accept=".apk" class="hidden">
                            
                            <!-- File Info -->
                            <div id="fileInfo" class="mt-4 hidden">
                                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-archive text-blue-500 mr-3"></i>
                                        <div>
                                            <p class="font-medium text-gray-900" id="fileName"></p>
                                            <p class="text-sm text-gray-600" id="fileSize"></p>
                                        </div>
                                    </div>
                                    <button onclick="clearFile()" class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end">
                            <button id="submitButton" onclick="submitPOC()" disabled
                                    class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center">
                                <i class="fas fa-rocket mr-2"></i>
                                <span id="submitText">Submit POC</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status & Queue Section -->
            <div class="lg:col-span-1">
                <!-- Current Status -->
                <div class="bg-white rounded-lg shadow-sm border mb-6">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">Status</h3>
                    </div>
                    <div class="p-6">
                        <div id="statusSection" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm font-medium text-gray-700">Current Job</span>
                                <span id="jobId" class="text-xs bg-gray-100 px-2 py-1 rounded"></span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                    <span id="statusText">Connecting...</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Status Details -->
                            <div id="statusDetails" class="space-y-2">
                                <!-- Status items will be added here -->
                            </div>

                            <!-- Error Display -->
                            <div id="errorDisplay" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                                    <span class="text-red-700 font-medium">Error</span>
                                </div>
                                <p id="errorMessage" class="text-red-600 text-sm mt-1"></p>
                            </div>

                            <!-- Success Display -->
                            <div id="successDisplay" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        <span class="text-green-700 font-medium">Completed</span>
                                    </div>
                                    <button onclick="viewScreenshot()" class="text-green-600 hover:text-green-800 text-sm">
                                        <i class="fas fa-image mr-1"></i>View Screenshot
                                    </button>
                                </div>
                                <p class="text-green-600 text-sm mt-1">POC testing completed successfully.</p>
                                <div class="flex items-center justify-between mt-2 pt-2 border-t border-green-200">
                                    <span class="text-green-600 text-sm">Time taken:</span>
                                    <span id="processingTime" class="text-green-700 font-medium text-sm">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="loadingState" class="hidden text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p class="text-gray-600 font-medium">Loading status...</p>
                            <p class="text-sm text-gray-400 mt-1">Connecting to the server...</p>
                        </div>

                        <!-- Initial State -->
                        <div id="initialState" class="text-center py-8">
                            <i class="fas fa-upload text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-500">No active jobs</p>
                            <p class="text-sm text-gray-400">Upload a POC to get started</p>
                        </div>
                    </div>
                </div>

                <!-- Queue Overview -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">Queue Overview</h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Queue Size</span>
                                <span id="queueSize" class="font-medium">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshotModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg max-w-4xl max-h-screen overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Screenshot</h3>
                <button onclick="closeScreenshotModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <img id="screenshotImage" src="" alt="POC Screenshot" class="max-w-full max-h-96 mx-auto">
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toasts will be added here -->
    </div>

<script>
        let currentJobId = null;
        let selectedFile = null;
        let socket = null;
        let isLoadingFromUrl = false;

        function getUrlParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        function updateUrlParameter(key, value) {
            const url = new URL(window.location);
            value ? url.searchParams.set(key, value) : url.searchParams.delete(key);
            window.history.replaceState({}, '', url);
        }

        $(document).ready(function() {
            initializeDropZone();
            initializeFormValidation();
            initializeWebSocket();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            const existingId = getUrlParameter('id');
            if (existingId) {
                currentJobId = existingId;
                isLoadingFromUrl = true;
                showLoadingState();
            }
        });

        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                
                if (currentJobId) {
                    joinQueueRoom(currentJobId);
                    requestCurrentStatus(currentJobId);
                }
            });
            
            socket.on('disconnect', () => console.log('Disconnected from server'));
            socket.on('status_update', updateStatusDisplay);
            socket.on('queue_stats', updateQueueStats);
            
            socket.on('error', function(data) {
                showToast(data.message || 'WebSocket error occurred', 'error');
                
                if (data.message === 'Queue item not found' && currentJobId) {
                    updateUrlParameter('id', null);
                    currentJobId = null;
                    isLoadingFromUrl = false;
                    $('#statusSection').addClass('hidden');
                    $('#loadingState').addClass('hidden');
                    $('#initialState').removeClass('hidden');
                }
            });
        }

        function updateCurrentTime() {
            $('#currentTime').text(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        }

        function initializeDropZone() {
            const $dropZone = $('#dropZone');
            const $fileInput = $('#fileInput');

            $dropZone.on('click', () => $fileInput.click());
            
            $dropZone.on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('border-primary bg-blue-50');
            });

            $dropZone.on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('border-primary bg-blue-50');
            });

            $dropZone.on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('border-primary bg-blue-50');
                
                const files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) handleFile(files[0]);
            });

            $fileInput.on('change', function() {
                if (this.files.length > 0) handleFile(this.files[0]);
            });
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.apk')) {
                showToast('Only APK files are allowed', 'error');
                return;
            }

            selectedFile = file;
            $('#fileName').text(file.name);
            $('#fileSize').text(formatFileSize(file.size));
            $('#fileInfo').removeClass('hidden');
            $('#dropZone').addClass('hidden');
            
            validateForm();
        }

        function clearFile() {
            selectedFile = null;
            $('#fileInfo').addClass('hidden');
            $('#dropZone').removeClass('hidden');
            $('#fileInput').val('');
            validateForm();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function initializeFormValidation() {
            $('#challengeSelect, #powSolution').on('change input', validateForm);
        }

        function validateForm() {
            const challenge = $('#challengeSelect').val();
            const solution = $('#powSolution').val();
            const hasFile = selectedFile !== null;
            
            $('#submitButton').prop('disabled', !(challenge && solution && hasFile));
        }

        function submitPOC() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('chall_name', $('#challengeSelect').val());
            formData.append('solution', $('#powSolution').val());

            const $submitButton = $('#submitButton');
            const $submitText = $('#submitText');
            
            $submitButton.prop('disabled', true);
            $submitText.text('Submitting...');

            $.ajax({
                url: '/upload',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(result) {
                    if (result.status === 'success') {
                        $('#powCommand').text(`curl -sSfL https://pwn.red/pow | sh -s ${result.challenge}`);
                        $('#powCopyButton').attr('onclick', `copyToClipboard('curl -sSfL https://pwn.red/pow | sh -s ${result.challenge}')`);
                        currentJobId = result.id;
                        isLoadingFromUrl = false;
                        updateUrlParameter('id', result.id);
                        showStatusSection();
                        joinQueueRoom(result.id);
                        requestCurrentStatus(result.id);
                        showToast('POC submitted successfully!', 'success');
                        resetForm();
                    } else {
                        showToast(result.message || 'Upload failed', 'error');
                    }
                },
                error: () => showToast('Network error occurred', 'error'),
                complete: function() {
                    $submitButton.prop('disabled', false);
                    $submitText.text('Submit POC');
                }
            });
        }

        function showLoadingState() {
            $('#initialState').addClass('hidden');
            $('#loadingState').removeClass('hidden');
            $('#statusSection').addClass('hidden');
        }

        function showStatusSection() {
            $('#initialState').addClass('hidden');
            $('#loadingState').addClass('hidden');
            $('#statusSection').removeClass('hidden');
            $('#jobId').text(currentJobId);
            resetStatusDisplay();
        }

        function resetStatusDisplay() {
            $('#errorDisplay, #successDisplay').addClass('hidden');
            $('#progressBar').css('width', '0%').removeClass('bg-green-500').addClass('bg-primary');
            $('#progressPercent').text('0%');
            $('#statusText').text('Connecting...');
            $('#processingTime').text('-');
        }

        function joinQueueRoom(queueId) {
            socket?.emit('join_queue', { queue_id: queueId });
        }

        function leaveQueueRoom(queueId) {
            socket?.emit('leave_queue', { queue_id: queueId });
        }

        function requestCurrentStatus(queueId) {
            socket?.emit('get_status', { queue_id: queueId });
        }

        function updateQueueStats(stats) {
            $('#queueSize').text(stats.queue_size);
        }

        function updateStatusDisplay(status) {
            if (isLoadingFromUrl) {
                showStatusSection();
                isLoadingFromUrl = false;
            }

            const statusMessages = {
                'PENDING_QUEUE': 'Waiting for queue...',
                'INITIALIZING': 'Initializing...',
                'INSTALLING_POC': 'Installing POC application...',
                'RUNNING_CHALLENGE': 'Running challenge application...',
                'RUNNING_POC': 'Running POC application...',
                'TAKING_SCREENSHOT': 'Taking screenshot...',
                'COMPLETED': 'Completed successfully!',
                'ERROR': 'An error occurred!'
            };

            const progressValues = {
                'PENDING_QUEUE': 0,
                'INITIALIZING': 15,
                'INSTALLING_POC': 30,
                'RUNNING_CHALLENGE': 50,
                'RUNNING_POC': 75,
                'TAKING_SCREENSHOT': 90,
                'COMPLETED': 100,
                'ERROR': 100
            };

            const $progressBar = $('#progressBar');
            const progress = progressValues[status.status] || 0;

            console.log(status);
            console.log(statusMessages[status.status]);
            console.log(progressValues[status.status]);

            $('#statusText').text(statusMessages[status.status] || status.status);
            $progressBar.css('width', `${progress}%`).removeClass('bg-green-500')
                .removeClass('bg-red-500')
                .addClass('bg-primary');
            $('#progressPercent').text(`${progress}%`);

            if (status.status === 'ERROR') {
                $('#errorMessage').text(status.error || 'Unknown error occurred');
                $('#errorDisplay').removeClass('hidden');
                $progressBar.removeClass('bg-green-500').addClass('bg-red-500');
                if (currentJobId) leaveQueueRoom(currentJobId);
            } else if (status.status === 'COMPLETED') {
                $('#successDisplay').removeClass('hidden');
                $progressBar.removeClass('bg-red-500').addClass('bg-green-500');
                
                if (status.duration) {
                    $('#processingTime').text(`${status.duration}s`);
                }
                
                if (currentJobId) leaveQueueRoom(currentJobId);
            }
        }

        function viewScreenshot() {
            if (!currentJobId) return;
            $('#screenshotImage').attr('src', `/screenshot/${currentJobId}`);
            $('#screenshotModal').removeClass('hidden');
        }

        function closeScreenshotModal() {
            $('#screenshotModal').addClass('hidden');
        }

        function resetForm() {
            $('#challengeSelect').val('');
            $('#powSolution').val('');
            clearFile();
            validateForm();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Command copied to clipboard!', 'success');
            });
        }

        function showToast(message, type = 'info') {
            const bgColor = type === 'error' ? 'bg-red-500' : 
                           type === 'success' ? 'bg-green-500' : 
                           'bg-blue-500';
            
            const $toast = $(`
                <div class="${bgColor} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full">
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                </div>
            `);
            
            $('#toastContainer').append($toast);
            
            setTimeout(() => $toast.removeClass('translate-x-full'), 100);
            setTimeout(() => {
                $toast.addClass('translate-x-full');
                setTimeout(() => $toast.remove(), 300);
            }, 3000);
        }

        $('#screenshotModal').on('click', function(e) {
            if (e.target === this) closeScreenshotModal();
        });

        $(window).on('beforeunload', function() {
            if (currentJobId) leaveQueueRoom(currentJobId);
        });
</script>
</body>
</html>
